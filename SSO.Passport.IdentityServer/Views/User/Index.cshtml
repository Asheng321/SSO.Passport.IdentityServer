
@{
    ViewBag.Title = "用户列表";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/Content/global/plugins/datatables/jquery.dataTables.js"></script>
<script src="~/Content/global/plugins/datatables/dataTables.bootstrap.js"></script>
<link href="~/Content/global/plugins/datatables/dataTables.bootstrap.css" rel="stylesheet" />

<style type="text/css">
    .modal-dialog {
        top: 35%;
        width: 220px;
    }

    .modal-dialog {
        top: 35%;
        width: 220px;
    }

    .modal-dialog {
        top: 35%;
        width: 220px;
    }

    .modal-dialog {
        top: 35%;
        width: 220px;
    }
</style>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <button type="button" class="btn btn-default pull-right" onclick="goToPage('/User/Add');">添加用户</button>
            </div>
            <div class="box-body">
                <table id="userInfosTable" class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>用户名</th>
                        <th>手机号码</th>
                        <th>Email</th>
                        <th>最后登录时间</th>
                        <th>配置</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 模态框（Modal） -->
    <div class="modal fade" id="deleteWindow" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="deleteModalLabel">
                        警告
                    </h4>
                </div>
                <div class="modal-body">
                    确认删除？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        取消
                    </button>
                    <button type="button" class="btn btn-primary" id="delWinBtnRight">
                        确认
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
</div>


<!-- 模态框（Modal） -->
<div class="modal fade" id="warningAlert" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="warningModalLabel">
                    警告
                </h4>
                <div class="modal-body" id="warningModelBody">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    确定
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<input type="hidden" id="deleteId"/>
<script>
	$(function() {

        $('#userInfosTable').DataTable({
	        "language": {
		        "sProcessing": "正在处理中，请稍候...",
		        "sLengthMenu": "每页显示 _MENU_ 项",
		        "sZeroRecords": "没有匹配结果",
		        "sInfo": "显示第 _START_ 至 _END_ 项，共 _TOTAL_ 项",
		        "sInfoEmpty": "显示第 0 至 0 项，共 0 项",
		        "sInfoFiltered": "(由 _MAX_ 项过滤)",
		        "sInfoPostFix": "",
		        "sSearch": "搜索:",
		        "sUrl": "",
		        "sEmptyTable": "表中数据为空",
		        "sLoadingRecords": "正在拼命加载...",
		        "sInfoThousands": ",",
		        "oPaginate": {
			        "sFirst": "首页",
			        "sPrevious": "上一页",
			        "sNext": "下一页",
			        "sLast": "末页"
		        },
		        "oAria": {
			        "sSortAscending": ": 以升序排列此列",
			        "sSortDescending": ": 以降序排列此列"
		        },
		        "deferRender": true
	        },
			"processing": true,
			"serverSide": true,
            "ajax": "/User/GetPageData",
			"paging": true,
			"lengthChange": true,
			"searching": true,
			"ordering": false,
			"info": true,
			"autoWidth": true,
			"columns": [
				{
					"data": "Username"
				},
				{
					"data": "PhoneNumber"
				},
				{
					"data": "Email"
				},
				{
					"data": "LastLoginTime"
				},
				{
					"data": "LastLoginTime"
				},
				{
					"data": "LastLoginTime"
				}
			],
			"createdRow": function(row, data, index) {
				$('td', row).eq(4).html(
					"<a type='button' class='btn btn-default' href='/User/Group/" + data.Id +"'>用户组</a> "+
					"<a type='button' class='btn btn-default' href='/User/Permission/" + data.Id +"'>临时权限</a> "+
					"<a type='button' class='btn btn-default' href='/User/Role/" + data.Id +"'>角色</a> "
				);
				$('td', row).eq(5).html(
                    "<a type='button' class='btn btn-default' href='/User/Get/" + data.Id + "'>详细</a>"+
					"<button type='button' class='btn btn-default' onclick='goToPage(\"/User/Edit/" + data.Id +"\");'>修改</button> " +
					"<button type='button' class='btn btn-default' onclick='openDeleteWindow(\"" + data.Id + "\");'>删除</button>" +
					"<a type='button' class='btn btn-default' href='/User/ChangePassword/"+ data.Id +"'>修改密码</a>"
				);
			}
		});
	});
    
	$("#delWinBtnRight").bind("click", function() {
		var uid = $("#deleteId").val();
		$.ajax({
			type: "Post",
			url: "/User/Delete",
			data: {
				id: uid
			},
			dataType: "json",
			success: function(data) {
				if (data.Success) {
					location.reload();
				} else {
					showWarningAlert(data.Message);
				}
				$("#deleteWindow").modal("hide");
			}
		});

	});

	function showWarningAlert(warningMsg) {
		$("#warningAlert").modal("show");
		//5秒后自动关
		setTimeout(function() { $('#warningAlert').modal("hide"); }, 5000);
	}

	function goToPage(targetUrl) {
		window.location.href = targetUrl;
	}

	function openDeleteWindow(uid) {
		$("#deleteId").val(uid);
		$("#deleteWindow").modal("show");

	}
</script>
